{% extends "base.html" %}
{% block title %}{{ individual.name }} - Jeremy's CRM{% endblock %}
{% block content %}
<div class="detail-header">
    <h1>{{ individual.name }}</h1>
    <div class="detail-actions">
        <a href="{{ url_for('edit_individual', id=individual.id) }}" class="btn">Edit</a>
        <form method="post" action="{{ url_for('delete_individual', id=individual.id) }}" class="inline-form"
              onsubmit="return confirm('Delete this individual?')">
            <button type="submit" class="btn btn-danger">Delete</button>
        </form>
    </div>
</div>

<div class="detail-card">
    <div class="detail-fields">
        {% if individual.title %}<div class="field"><label>Title</label><span>{{ individual.title }}</span></div>{% endif %}
        {% if individual.email %}<div class="field"><label>Email</label><a href="mailto:{{ individual.email }}">{{ individual.email }}</a></div>{% endif %}
        {% if individual.phone %}<div class="field"><label>Phone</label><span>{{ individual.phone }}</span></div>{% endif %}
        {% if individual.linkedin_url %}<div class="field"><label>LinkedIn</label><a href="{{ individual.linkedin_url }}" target="_blank">{{ individual.linkedin_url }}</a></div>{% endif %}
        {% if individual.location %}<div class="field"><label>Location</label><span>{{ individual.location }}</span></div>{% endif %}
        <div class="field"><label>Added</label><span>{{ individual.created_at|datefmt }}</span></div>
    </div>
</div>

<div class="section">
    <h2>Relationships</h2>
    {% if related %}
    <ul class="relationship-list">
        {% for r in related %}
        <li>
            <a href="{{ url_for('company_detail' if r.other_type == 'company' else 'individual_detail', id=r.other.id) }}">
                {{ r.other.name }}
            </a>
            <span class="rel-type">{{ r.rel.relationship_type }}</span>
            <form method="post" action="{{ url_for('delete_relationship', id=r.rel.id) }}" class="inline-form">
                <input type="hidden" name="redirect_type" value="individual">
                <input type="hidden" name="redirect_id" value="{{ individual.id }}">
                <button type="submit" class="btn-small btn-danger">Remove</button>
            </form>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty">No relationships yet.</p>
    {% endif %}

    <form method="post" action="{{ url_for('add_relationship') }}" class="add-form">
        <input type="hidden" name="from_type" value="individual">
        <input type="hidden" name="from_id" value="{{ individual.id }}">
        <div class="form-row">
            <select name="to_type" id="to_type_individual" onchange="updateRelTargets(this)">
                <option value="company">Company</option>
                <option value="individual">Individual</option>
            </select>
            <div class="select-search-wrapper">
                <input type="text" class="filter-input" placeholder="Search..." onkeyup="filterSelect(this, 'to_id_individual')">
                <select name="to_id" id="to_id_individual" size="4">
                    {% for c in all_companies %}
                    <option value="{{ c.id }}">{{ c.name }}</option>
                    {% endfor %}
                </select>
            </div>
            <input type="text" name="relationship_type" placeholder="Relationship type" required>
            <button type="submit" class="btn">Add</button>
        </div>
    </form>
</div>

<div class="section">
    <h2>Notes</h2>
    {% if notes %}
    <ul class="notes-list">
        {% for note in notes %}
        <li>
            <p>{{ note.note_text }}</p>
            <div class="note-meta">
                <span>{{ note.created_at|datefmt }}</span>
                <form method="post" action="{{ url_for('delete_note', id=note.id) }}" class="inline-form">
                    <button type="submit" class="btn-small btn-danger">Delete</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
    {% else %}
    <p class="empty">No notes yet.</p>
    {% endif %}

    <form method="post" action="{{ url_for('add_note') }}" class="add-form">
        <input type="hidden" name="entity_type" value="individual">
        <input type="hidden" name="entity_id" value="{{ individual.id }}">
        <div class="form-row">
            <textarea name="note_text" placeholder="Add a note..." required></textarea>
            <button type="submit" class="btn">Add Note</button>
        </div>
    </form>
</div>

<div class="section">
    <h2>Follow-Ups</h2>
    {% if follow_ups %}
    <div class="follow-up-list">
        {% for item in follow_ups %}
        <div class="follow-up-card">
            <div class="follow-up-header">
                <h3>{{ item.follow_up.title }}</h3>
                <div class="follow-up-actions">
                    <span class="meta">{{ item.follow_up.created_at|datefmt }}</span>
                    <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                </div>
            </div>
            {% if item.follow_up.body %}
            <p class="follow-up-body">{{ item.follow_up.body }}</p>
            {% endif %}
            {% if item.links %}
            <div class="follow-up-links">
                {% for link in item.links %}
                <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                   class="tag tag-link">{{ link.name }}</a>
                {% endfor %}
            </div>
            {% endif %}
            {% if item.comments %}
            <div class="follow-up-comments">
                {% for comment in item.comments %}
                <div class="follow-up-comment" id="comment-{{ comment.id }}">
                    <div class="comment-content">
                        <p>{{ comment.comment_text }}</p>
                        <div class="comment-meta">
                            <span class="meta">{{ comment.created_at|datefmt }}</span>
                            <div class="comment-actions">
                                <button type="button" class="btn-small" onclick="editComment({{ comment.id }}, this)">Edit</button>
                                <form method="post" action="{{ url_for('delete_follow_up_comment', id=comment.id) }}" class="inline-form"
                                      onsubmit="return confirm('Delete this comment?')">
                                    <button type="submit" class="btn-small btn-danger">Delete</button>
                                </form>
                            </div>
                        </div>
                    </div>
                    <form method="post" action="{{ url_for('edit_follow_up_comment', id=comment.id) }}" class="comment-edit-form" style="display:none">
                        <div class="form-row">
                            <input type="text" name="comment_text" value="{{ comment.comment_text }}" required>
                            <button type="submit" class="btn">Save</button>
                            <button type="button" class="btn btn-secondary" onclick="cancelEditComment({{ comment.id }})">Cancel</button>
                        </div>
                    </form>
                </div>
                {% endfor %}
            </div>
            {% endif %}
            <form method="post" action="{{ url_for('add_follow_up_comment', id=item.follow_up.id) }}" class="comment-form">
                <div class="form-row">
                    <input type="text" name="comment_text" placeholder="Add a follow-up comment..." required>
                    <button type="submit" class="btn">Comment</button>
                </div>
            </form>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <p class="empty">No follow-ups linked to this individual.</p>
    {% endif %}
</div>

<script>
function filterSelect(input, selectId) {
    const filter = input.value.toLowerCase();
    const options = document.getElementById(selectId).options;
    for (let i = 0; i < options.length; i++) {
        const text = options[i].textContent.toLowerCase();
        options[i].style.display = text.includes(filter) ? '' : 'none';
    }
}
function editComment(commentId) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = 'none';
    commentDiv.querySelector('.comment-edit-form').style.display = 'block';
}
function cancelEditComment(commentId) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = '';
    commentDiv.querySelector('.comment-edit-form').style.display = 'none';
}
function updateRelTargets(select) {
    const toId = document.getElementById('to_id_individual');
    const companies = [{% for c in all_companies %}{ id: {{ c.id }}, name: "{{ c.name }}" },{% endfor %}];
    const individuals = [{% for i in all_individuals %}{ id: {{ i.id }}, name: "{{ i.name }}" },{% endfor %}];
    const items = select.value === 'company' ? companies : individuals;
    toId.innerHTML = items.map(i => `<option value="${i.id}">${i.name}</option>`).join('');
}
</script>
{% endblock %}
