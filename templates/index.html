{% extends "base.html" %}
{% block title %}Jeremy's CRM - Home{% endblock %}
{% block content %}
<div class="search-section">
    <h1>Search</h1>
    <form method="get" action="{{ url_for('index') }}" class="search-form">
        <input type="text" name="q" value="{{ query }}" placeholder="Search companies and individuals...">
        <button type="submit">Search</button>
    </form>
</div>

<div class="home-grid">
    <div class="home-col home-col-narrow">
        <h2>Companies ({{ companies|length }})</h2>
        {% if companies %}
        <ul class="entity-list sortable-list" id="sortable-companies">
            {% for c in companies %}
            <li data-id="{{ c.id }}">
                <div class="entity-card">
                    <div class="entity-card-header">
                        <span class="drag-handle">&#x2630;</span>
                        <a href="{{ url_for('company_detail', id=c.id) }}"><strong>{{ c.name }}</strong></a>
                    </div>
                    {% if c.type %}<span class="tag">{{ c.type }}</span>{% endif %}
                    {% for rel in company_rels.get(c.id, []) %}
                    <span class="tag tag-rel">{{ rel.name }}</span>
                    {% endfor %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty">No companies found.</p>
        {% endif %}
    </div>

    <div class="home-col home-col-narrow">
        <h2>Individuals ({{ individuals|length }})</h2>
        {% if individuals %}
        <ul class="entity-list sortable-list" id="sortable-individuals">
            {% for i in individuals %}
            <li data-id="{{ i.id }}">
                <div class="entity-card">
                    <div class="entity-card-header">
                        <span class="drag-handle">&#x2630;</span>
                        <a href="{{ url_for('individual_detail', id=i.id) }}"><strong>{{ i.name }}</strong></a>
                    </div>
                    {% if i.title %}<span class="meta">{{ i.title }}</span>{% endif %}
                    {% for rel in individual_rels.get(i.id, []) %}
                    <span class="tag tag-rel">{{ rel.name }}</span>
                    {% endfor %}
                </div>
            </li>
            {% endfor %}
        </ul>
        {% else %}
        <p class="empty">No individuals found.</p>
        {% endif %}
    </div>

    <div class="home-col home-col-wide">
        <h2>Notes</h2>
        {% if follow_up_data %}
        <div class="follow-up-list sortable-list" id="sortable-follow-ups">
            {% for item in follow_up_data %}
            <div class="follow-up-card{% if item.follow_up.priority %} follow-up-priority{% endif %}" data-id="{{ item.follow_up.id }}" id="follow-up-{{ item.follow_up.id }}">
                <div class="follow-up-header">
                    <span class="drag-handle">&#x2630;</span>
                    <h3>{{ item.follow_up.title }}</h3>
                    <div class="follow-up-actions">
                        <form method="post" action="{{ url_for('toggle_priority', id=item.follow_up.id) }}" class="inline-form">
                            <button type="submit" class="btn-flag{% if item.follow_up.priority %} flagged{% endif %}" title="Toggle priority">&#9873;</button>
                        </form>
                        <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                        <form method="post" action="{{ url_for('delete_follow_up', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Delete this follow-up?')">
                            <button type="submit" class="btn-small btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
                <span class="meta">{{ item.follow_up.created_at|datefmt }}</span>
                {% if item.follow_up.body %}
                <p class="follow-up-body">{{ item.follow_up.body }}</p>
                {% endif %}
                {% if item.links %}
                <div class="follow-up-links">
                    {% for link in item.links %}
                    <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                       class="tag tag-link">{{ link.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}

                {% if item.comments %}
                <div class="follow-up-comments">
                    {% for comment in item.comments %}
                    <div class="follow-up-comment" id="comment-{{ comment.id }}">
                        <div class="comment-content">
                            <p>{{ comment.comment_text }}</p>
                            <div class="comment-meta">
                                <span class="meta">{{ comment.created_at|datefmt }}</span>
                                <div class="comment-actions">
                                    <button type="button" class="btn-small" onclick="editComment({{ comment.id }}, this)">Edit</button>
                                    <form method="post" action="{{ url_for('delete_follow_up_comment', id=comment.id) }}" class="inline-form"
                                          onsubmit="return confirm('Delete this comment?')">
                                        <button type="submit" class="btn-small btn-danger">Delete</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                        <form method="post" action="{{ url_for('edit_follow_up_comment', id=comment.id) }}" class="comment-edit-form" style="display:none">
                            <div class="form-row">
                                <input type="text" name="comment_text" value="{{ comment.comment_text }}" required>
                                <button type="submit" class="btn">Save</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEditComment({{ comment.id }})">Cancel</button>
                            </div>
                        </form>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <form method="post" action="{{ url_for('add_follow_up_comment', id=item.follow_up.id) }}" class="comment-form">
                    <div class="form-row">
                        <input type="text" name="comment_text" placeholder="Add a follow-up comment..." required>
                        <button type="submit" class="btn">Comment</button>
                    </div>
                </form>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty">No notes yet.</p>
        {% endif %}
    </div>

    <div class="home-col home-col-wide">
        <h2>New Note</h2>
        <form method="post" action="{{ url_for('add_follow_up') }}" class="follow-up-form">
            <div class="form-group">
                <input type="text" name="title" placeholder="Title" required>
            </div>
            <div class="form-group">
                <textarea name="body" placeholder="Details..."></textarea>
            </div>
            <div class="form-group">
                <label>Link Companies</label>
                <input type="text" class="filter-input" placeholder="Search companies..." onkeyup="filterList(this, 'new-note-companies')">
                <div class="checkbox-list" id="new-note-companies">
                    {% for c in all_companies %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="link_companies" value="{{ c.id }}"> {{ c.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <div class="form-group">
                <label>Link Individuals</label>
                <input type="text" class="filter-input" placeholder="Search individuals..." onkeyup="filterList(this, 'new-note-individuals')">
                <div class="checkbox-list" id="new-note-individuals">
                    {% for i in all_individuals %}
                    <label class="checkbox-item">
                        <input type="checkbox" name="link_individuals" value="{{ i.id }}"> {{ i.name }}
                    </label>
                    {% endfor %}
                </div>
            </div>
            <button type="submit" class="btn">Create Note</button>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
function initSortable(elId, type) {
    const el = document.getElementById(elId);
    if (!el) return;
    Sortable.create(el, {
        handle: '.drag-handle',
        animation: 150,
        onEnd: function() {
            const ids = Array.from(el.children)
                .filter(c => c.dataset.id)
                .map(c => c.dataset.id);
            fetch('/reorder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type, ids: ids})
            });
        }
    });
}
initSortable('sortable-companies', 'companies');
initSortable('sortable-individuals', 'individuals');
initSortable('sortable-follow-ups', 'follow_ups');

function filterList(input, listId) {
    const filter = input.value.toLowerCase();
    const items = document.getElementById(listId).querySelectorAll('.checkbox-item');
    items.forEach(function(item) {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(filter) ? '' : 'none';
    });
}

function filterSelect(input, selectId) {
    const filter = input.value.toLowerCase();
    const options = document.getElementById(selectId).options;
    for (let i = 0; i < options.length; i++) {
        const text = options[i].textContent.toLowerCase();
        options[i].style.display = text.includes(filter) ? '' : 'none';
    }
}

function editComment(commentId, btn) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = 'none';
    commentDiv.querySelector('.comment-edit-form').style.display = 'block';
}
function cancelEditComment(commentId) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = '';
    commentDiv.querySelector('.comment-edit-form').style.display = 'none';
}
</script>
{% endblock %}
