{% extends "base.html" %}
{% block title %}Jeremy's CRM - Home{% endblock %}
{% block content %}
<div class="home-links">
    <a href="{{ url_for('company_list') }}" class="btn btn-secondary">Companies</a>
    <a href="{{ url_for('individual_list') }}" class="btn btn-secondary">Individuals</a>
    <a href="{{ url_for('proposals') }}" class="btn btn-proposals">Proposals Pipeline</a>
</div>

<div class="search-section">
    <form method="get" action="{{ url_for('index') }}" class="search-form">
        <input type="text" name="q" value="{{ query }}" placeholder="Search opportunities...">
        <button type="submit">Search</button>
        {% if query %}<a href="{{ url_for('index') }}" class="btn btn-secondary">Clear</a>{% endif %}
    </form>
</div>

<div class="home-grid-3">
    <div class="home-col">
        <h2 class="collapsible" onclick="toggleSection(this)"><span class="collapse-icon">&#9660;</span> Top Priority</h2>
        <div class="collapsible-content">
        {% if priority_data %}
        <div class="follow-up-list sortable-list" id="sortable-priority">
            {% for item in priority_data %}
            <div class="follow-up-card follow-up-priority" data-id="{{ item.follow_up.id }}">
                <div class="follow-up-header">
                    <span class="drag-handle">&#x2630;</span>
                    <span class="opp-toggle" onclick="toggleOpp('pri-details-{{ item.follow_up.id }}', this)">&#9654;</span>
                    <h3>{{ item.follow_up.title }}</h3>
                    {% if item.follow_up.opp_type %}<span class="tag tag-opp">{{ item.follow_up.opp_type }}</span>{% endif %}
                    <div class="follow-up-actions">
                        <form method="post" action="{{ url_for('set_priority', id=item.follow_up.id, level=2) }}" class="inline-form">
                            <button type="submit" class="btn-flag flagged-red" title="Remove from Top Priority">&#9873;</button>
                        </form>
                        <form method="post" action="{{ url_for('toggle_close_follow_up', id=item.follow_up.id) }}" class="inline-form">
                            <button type="submit" class="btn-small btn-close-opp" title="Close Opportunity">&#10003;</button>
                        </form>
                        <form method="post" action="{{ url_for('convert_to_proposal', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Create a proposal from this opportunity? The opportunity will be closed.')">
                            <button type="submit" class="btn-small btn-convert" title="Convert to Proposal">&rarr; Proposal</button>
                        </form>
                        <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                    </div>
                </div>
                {% if item.links %}
                <div class="follow-up-links">
                    {% for link in item.links %}
                    <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                       class="tag tag-link-{{ link.type }}">{{ link.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.proposals %}
                <div class="follow-up-links">
                    {% for prop in item.proposals %}
                    <a href="{{ url_for('edit_proposal', id=prop.id) }}" class="tag tag-link-proposal">{{ prop.name }} ({{ prop.status }})</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="opp-details" id="pri-details-{{ item.follow_up.id }}" style="display:none">
                    <span class="meta">{{ item.follow_up.created_at|datefmt }}</span>
                    {% if item.follow_up.body %}
                    <p class="follow-up-body">{{ item.follow_up.body }}</p>
                    {% endif %}
                    {% if item.comments %}
                    <div class="follow-up-comments">
                        {% for comment in item.comments %}
                        <div class="follow-up-comment">
                            <p>{{ comment.comment_text }}</p>
                            <span class="meta">{{ comment.created_at|datefmt }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <form method="post" action="{{ url_for('add_follow_up_comment', id=item.follow_up.id) }}" class="comment-form">
                        <div class="form-row">
                            <input type="text" name="comment_text" placeholder="Add a note..." required>
                            <button type="submit" class="btn">Comment</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty">Red-flag opportunities to add them here.</p>
        {% endif %}
        </div>
    </div>

    <div class="home-col">
        <h2 class="collapsible" onclick="toggleSection(this)"><span class="collapse-icon">&#9660;</span> Watch List</h2>
        <div class="collapsible-content">
        {% if watch_data %}
        <div class="follow-up-list sortable-list" id="sortable-watch">
            {% for item in watch_data %}
            <div class="follow-up-card follow-up-watch" data-id="{{ item.follow_up.id }}">
                <div class="follow-up-header">
                    <span class="drag-handle">&#x2630;</span>
                    <span class="opp-toggle" onclick="toggleOpp('watch-details-{{ item.follow_up.id }}', this)">&#9654;</span>
                    <h3>{{ item.follow_up.title }}</h3>
                    {% if item.follow_up.opp_type %}<span class="tag tag-opp">{{ item.follow_up.opp_type }}</span>{% endif %}
                    <div class="follow-up-actions">
                        <form method="post" action="{{ url_for('set_priority', id=item.follow_up.id, level=1) }}" class="inline-form">
                            <button type="submit" class="btn-flag flagged-yellow" title="Remove from Watch List">&#9873;</button>
                        </form>
                        <form method="post" action="{{ url_for('toggle_close_follow_up', id=item.follow_up.id) }}" class="inline-form">
                            <button type="submit" class="btn-small btn-close-opp" title="Close Opportunity">&#10003;</button>
                        </form>
                        <form method="post" action="{{ url_for('convert_to_proposal', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Create a proposal from this opportunity? The opportunity will be closed.')">
                            <button type="submit" class="btn-small btn-convert" title="Convert to Proposal">&rarr; Proposal</button>
                        </form>
                        <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                    </div>
                </div>
                {% if item.links %}
                <div class="follow-up-links">
                    {% for link in item.links %}
                    <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                       class="tag tag-link-{{ link.type }}">{{ link.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.proposals %}
                <div class="follow-up-links">
                    {% for prop in item.proposals %}
                    <a href="{{ url_for('edit_proposal', id=prop.id) }}" class="tag tag-link-proposal">{{ prop.name }} ({{ prop.status }})</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="opp-details" id="watch-details-{{ item.follow_up.id }}" style="display:none">
                    <span class="meta">{{ item.follow_up.created_at|datefmt }}</span>
                    {% if item.follow_up.body %}
                    <p class="follow-up-body">{{ item.follow_up.body }}</p>
                    {% endif %}
                    {% if item.comments %}
                    <div class="follow-up-comments">
                        {% for comment in item.comments %}
                        <div class="follow-up-comment">
                            <p>{{ comment.comment_text }}</p>
                            <span class="meta">{{ comment.created_at|datefmt }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                    <form method="post" action="{{ url_for('add_follow_up_comment', id=item.follow_up.id) }}" class="comment-form">
                        <div class="form-row">
                            <input type="text" name="comment_text" placeholder="Add a note..." required>
                            <button type="submit" class="btn">Comment</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty">Yellow-flag opportunities to add them here.</p>
        {% endif %}
        </div>
    </div>

    <div class="home-col">
        <h2 class="collapsible" onclick="toggleSection(this)"><span class="collapse-icon">&#9660;</span> Opportunities <a href="{{ url_for('add_follow_up_page') }}" class="btn-small" onclick="event.stopPropagation()" style="margin-left:0.5rem">+ New</a></h2>
        <div class="collapsible-content">
        {% if follow_up_data %}
        <div class="follow-up-list sortable-list" id="sortable-follow-ups">
            {% for item in follow_up_data %}
            <div class="follow-up-card{% if item.follow_up.priority_level == 2 %} follow-up-priority{% elif item.follow_up.priority_level == 1 %} follow-up-watch{% endif %}" data-id="{{ item.follow_up.id }}" id="follow-up-{{ item.follow_up.id }}">
                <div class="follow-up-header">
                    <span class="drag-handle">&#x2630;</span>
                    <span class="opp-toggle" onclick="toggleOpp('opp-details-{{ item.follow_up.id }}', this)">&#9654;</span>
                    <h3>{{ item.follow_up.title }}</h3>
                    {% if item.follow_up.opp_type %}<span class="tag tag-opp">{{ item.follow_up.opp_type }}</span>{% endif %}
                    <div class="follow-up-actions">
                        <form method="post" action="{{ url_for('set_priority', id=item.follow_up.id, level=2) }}" class="inline-form">
                            <button type="submit" class="btn-flag{% if item.follow_up.priority_level == 2 %} flagged-red{% endif %}" title="Top Priority">&#9873;</button>
                        </form>
                        <form method="post" action="{{ url_for('set_priority', id=item.follow_up.id, level=1) }}" class="inline-form">
                            <button type="submit" class="btn-flag{% if item.follow_up.priority_level == 1 %} flagged-yellow{% endif %}" title="Watch List">&#9873;</button>
                        </form>
                        <form method="post" action="{{ url_for('toggle_close_follow_up', id=item.follow_up.id) }}" class="inline-form">
                            <button type="submit" class="btn-small btn-close-opp" title="Close Opportunity">&#10003;</button>
                        </form>
                        <form method="post" action="{{ url_for('convert_to_proposal', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Create a proposal from this opportunity? The opportunity will be closed.')">
                            <button type="submit" class="btn-small btn-convert" title="Convert to Proposal">&rarr; Proposal</button>
                        </form>
                        <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                        <form method="post" action="{{ url_for('delete_follow_up', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Delete this opportunity?')">
                            <button type="submit" class="btn-small btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
                {% if item.links %}
                <div class="follow-up-links">
                    {% for link in item.links %}
                    <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                       class="tag tag-link-{{ link.type }}">{{ link.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.proposals %}
                <div class="follow-up-links">
                    {% for prop in item.proposals %}
                    <a href="{{ url_for('edit_proposal', id=prop.id) }}" class="tag tag-link-proposal">{{ prop.name }} ({{ prop.status }})</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="opp-details" id="opp-details-{{ item.follow_up.id }}" style="display:none">
                    <span class="meta">{{ item.follow_up.created_at|datefmt }}</span>
                    <div class="body-section" id="body-section-{{ item.follow_up.id }}">
                        <div class="body-display">
                            {% if item.follow_up.body %}
                            <p class="follow-up-body">{{ item.follow_up.body }}</p>
                            {% else %}
                            <p class="follow-up-body empty">No notes yet.</p>
                            {% endif %}
                            <button type="button" class="btn-small" onclick="editBody({{ item.follow_up.id }})">Edit Notes</button>
                        </div>
                        <form method="post" action="{{ url_for('update_follow_up_body', id=item.follow_up.id) }}" class="body-edit-form" style="display:none">
                            <textarea name="body" class="body-edit-textarea">{{ item.follow_up.body or '' }}</textarea>
                            <div class="form-row" style="margin-top:0.4rem">
                                <button type="submit" class="btn">Save</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelEditBody({{ item.follow_up.id }})">Cancel</button>
                            </div>
                        </form>
                    </div>

                    {% if item.comments %}
                    <div class="follow-up-comments">
                        {% for comment in item.comments %}
                        <div class="follow-up-comment" id="comment-{{ comment.id }}">
                            <div class="comment-content">
                                <p>{{ comment.comment_text }}</p>
                                <div class="comment-meta">
                                    <span class="meta">{{ comment.created_at|datefmt }}</span>
                                    <div class="comment-actions">
                                        <button type="button" class="btn-small" onclick="editComment({{ comment.id }})">Edit</button>
                                        <form method="post" action="{{ url_for('delete_follow_up_comment', id=comment.id) }}" class="inline-form"
                                              onsubmit="return confirm('Delete this comment?')">
                                            <button type="submit" class="btn-small btn-danger">Delete</button>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            <form method="post" action="{{ url_for('edit_follow_up_comment', id=comment.id) }}" class="comment-edit-form" style="display:none">
                                <div class="form-row">
                                    <input type="text" name="comment_text" value="{{ comment.comment_text }}" required>
                                    <button type="submit" class="btn">Save</button>
                                    <button type="button" class="btn btn-secondary" onclick="cancelEditComment({{ comment.id }})">Cancel</button>
                                </div>
                            </form>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <form method="post" action="{{ url_for('add_follow_up_comment', id=item.follow_up.id) }}" class="comment-form">
                        <div class="form-row">
                            <input type="text" name="comment_text" placeholder="Add a note..." required>
                            <button type="submit" class="btn">Comment</button>
                        </div>
                    </form>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="empty">No opportunities yet.</p>
        {% endif %}
        </div>
    </div>
</div>

{% if closed_data %}
<div class="closed-opportunities">
    <h2 class="collapsible" onclick="toggleSection(this)"><span class="collapse-icon">&#9654;</span> Closed Opportunities <span class="pipeline-count">{{ closed_data|length }}</span></h2>
    <div class="collapsible-content" style="display:none">
        <div class="follow-up-list">
            {% for item in closed_data %}
            <div class="follow-up-card follow-up-closed" id="follow-up-{{ item.follow_up.id }}">
                <div class="follow-up-header">
                    <span class="opp-toggle" onclick="toggleOpp('closed-details-{{ item.follow_up.id }}', this)">&#9654;</span>
                    <h3>{{ item.follow_up.title }}</h3>
                    {% if item.follow_up.opp_type %}<span class="tag tag-opp">{{ item.follow_up.opp_type }}</span>{% endif %}
                    <div class="follow-up-actions">
                        <form method="post" action="{{ url_for('toggle_close_follow_up', id=item.follow_up.id) }}" class="inline-form">
                            <button type="submit" class="btn-small" title="Reopen Opportunity">Reopen</button>
                        </form>
                        <a href="{{ url_for('edit_follow_up', id=item.follow_up.id) }}" class="btn-small">Edit</a>
                        <form method="post" action="{{ url_for('delete_follow_up', id=item.follow_up.id) }}" class="inline-form"
                              onsubmit="return confirm('Delete this opportunity?')">
                            <button type="submit" class="btn-small btn-danger">Delete</button>
                        </form>
                    </div>
                </div>
                {% if item.links %}
                <div class="follow-up-links">
                    {% for link in item.links %}
                    <a href="{{ url_for('company_detail' if link.type == 'company' else 'individual_detail', id=link.id) }}"
                       class="tag tag-link-{{ link.type }}">{{ link.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}
                {% if item.proposals %}
                <div class="follow-up-links">
                    {% for prop in item.proposals %}
                    <a href="{{ url_for('edit_proposal', id=prop.id) }}" class="tag tag-link-proposal">{{ prop.name }} ({{ prop.status }})</a>
                    {% endfor %}
                </div>
                {% endif %}
                <div class="opp-details" id="closed-details-{{ item.follow_up.id }}" style="display:none">
                    <span class="meta">Closed: {{ item.follow_up.closed_at|datefmt }}</span>
                    <span class="meta">Created: {{ item.follow_up.created_at|datefmt }}</span>
                    {% if item.follow_up.body %}
                    <p class="follow-up-body">{{ item.follow_up.body }}</p>
                    {% endif %}
                    {% if item.comments %}
                    <div class="follow-up-comments">
                        {% for comment in item.comments %}
                        <div class="follow-up-comment">
                            <p>{{ comment.comment_text }}</p>
                            <span class="meta">{{ comment.created_at|datefmt }}</span>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endif %}

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
function initSortable(elId, type) {
    const el = document.getElementById(elId);
    if (!el) return;
    Sortable.create(el, {
        handle: '.drag-handle',
        animation: 150,
        onEnd: function() {
            const ids = Array.from(el.children)
                .filter(c => c.dataset.id)
                .map(c => c.dataset.id);
            fetch('/reorder', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({type: type, ids: ids})
            });
        }
    });
}
initSortable('sortable-follow-ups', 'follow_ups');
initSortable('sortable-priority', 'priority_follow_ups');
initSortable('sortable-watch', 'watch_follow_ups');

function toggleSection(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.collapse-icon');
    const key = 'collapse-' + header.textContent.trim().split(' ')[1];
    if (content.style.display === 'none') {
        content.style.display = '';
        icon.innerHTML = '&#9660;';
        localStorage.removeItem(key);
    } else {
        content.style.display = 'none';
        icon.innerHTML = '&#9654;';
        localStorage.setItem(key, '1');
    }
}
document.querySelectorAll('.collapsible').forEach(function(header) {
    const key = 'collapse-' + header.textContent.trim().split(' ')[1];
    if (localStorage.getItem(key)) {
        header.nextElementSibling.style.display = 'none';
        header.querySelector('.collapse-icon').innerHTML = '&#9654;';
    }
});

function toggleOpp(detailsId, toggleEl) {
    const details = document.getElementById(detailsId);
    if (details.style.display === 'none') {
        details.style.display = '';
        toggleEl.innerHTML = '&#9660;';
    } else {
        details.style.display = 'none';
        toggleEl.innerHTML = '&#9654;';
    }
}

function editBody(fuId) {
    const section = document.getElementById('body-section-' + fuId);
    section.querySelector('.body-display').style.display = 'none';
    section.querySelector('.body-edit-form').style.display = 'block';
}
function cancelEditBody(fuId) {
    const section = document.getElementById('body-section-' + fuId);
    section.querySelector('.body-display').style.display = '';
    section.querySelector('.body-edit-form').style.display = 'none';
}

function editComment(commentId) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = 'none';
    commentDiv.querySelector('.comment-edit-form').style.display = 'block';
}
function cancelEditComment(commentId) {
    const commentDiv = document.getElementById('comment-' + commentId);
    commentDiv.querySelector('.comment-content').style.display = '';
    commentDiv.querySelector('.comment-edit-form').style.display = 'none';
}
</script>
{% endblock %}
